# Facebook
## 1. Целевая аудитория
- Страны СНГ
- [Около 34.5 млн ежемесячных пользователей](https://webindex.mediascope.net/report?byGeo=2&byDevice=3&byDevice=1&byDevice=2&byMonth=202107&id=77147)
- Возраст аудитории - [18-65 лет](https://www.statista.com/statistics/187549/facebook-distribution-of-users-age-group-usa/)
- Каждый пользоветель в среднем проводит на сайте около [8 минут в день](https://webindex.mediascope.net/report?byGeo=2&byDevice=3&byDevice=1&byDevice=2&byMonth=202107&id=77147)
### MVP
- Регистрация/авторизация
- Создание текстового поста с возможностью прикрепить изображение/ссылку
- Возможность добавить кого-то в "друзья", базовые ленты (общая/подписок)
## 2. Расчётная нагрузка
### Продуктовые метрики
- Месячная аудитория - 34.5 млн человек
- Дневная аудитория - [7.16 млн человек](https://webindex.mediascope.net/report?byGeo=2&byDevice=3&byDevice=1&byDevice=2&byMonth=202107&id=77147)
- Средний размер хранилища пользователя - [Как минимум 350 мегабайт на пользователя](https://www.statista.com/statistics/346167/facebook-global-dau/) (100 ПБ/2,9 млрд пользователей)
- Большая часть памяти - изображения, видео
#### Среднее количество действий пользователей
| Действие      | Количество    |
| ------------- |---------------|
| Создание постов      | [1.55 в день](https://blog.hootsuite.com/facebook-statistics/)|
| Просмотр постов      | ~10-100 в день      |
| Добавление кого-то в "друзья" | [338 за всё время существования аккаунта](https://www.pewresearch.org/fact-tank/2014/02/03/what-people-like-dislike-about-facebook/)|

### Технические метрики
- Рекомендованный размер изображений на Фейсбуке - [1200 на 1200 пикселей](https://www.facebook.com/business/help/469767027114079). Такое изображение весит примерно 3 МБ. Отсюда получаем около [3 МБ * 1.55 * 7.16 млн = 32 ТБ данных](https://www.google.com/search?q=3+*+1.55+*+7.16+*+1000000+%2F+1024+%2F+1024&ei=f7hWYdKfEfKqrgSO87C4Cw&ved=0ahUKEwiS29CF2KjzAhVylYsKHY45DLcQ4dUDCA4&uact=5&oq=3+*+1.55+*+7.16+*+1000000+%2F+1024+%2F+1024&gs_lcp=Cgdnd3Mtd2l6EAM6BwgAEEcQsANKBAhBGABQ6rMCWMfmB2Cl6wdoAXACeACAAWOIAb0FkgEBOJgBAKABAcgBCMABAQ&sclient=gws-wiz) (большая часть - фото и видео) в день
- В среднем за день сетевой трафик составляет около (50 * 4КБ(примерный размер изображений) + [11.4 МБ](https://ibb.co/d2LFJcW) (статика)) * 7.16 млн = 87 ТБ, что аналогично 1 ГБ/сек
- По сравнению с медиа и статикой, сетевой трафик прочих запросов крайне, пренебрежимо мал

#### RPS по типам запросов
|Тип запроса|RPS|
| ------------- |---------------|
|Создание постов|129|
|Просмотр постов|4000|
|Добавление в друзья|37|

#### Логическая схема
![relations drawio](https://user-images.githubusercontent.com/27278247/143012882-4f356c57-1835-4f59-8811-31a10d2937b2.png)
- Для сохранения древовидной структуры комментариев будем использовать материализованные списки - они довольно просты в использовании, а недостатки вроде сложности поиска по этим спискам нивелируются использованием индекса BTree

#### Физическая схема
![relations-Физическая схема drawio](https://user-images.githubusercontent.com/27278247/147126449-56f9a231-1c62-4a00-b504-8e2b3f11e331.png)
- Пользовательские сессии, имена, пароли, хеши, соль и всё прочее, связанное с авторизацией и её проверкой хранится в Redis
Остальное - в PostgreSQL
- Индексы - помимо базовых, возникающих вследствие foreign key - зависимостей, используем btree по путям к комментариям, возможно btree по первому элементу в пути, btree по пользователям в чате
- Шардирование - явно стоит разделить чаты, пользователей, и посты/группы/комментарии по отдельным шардам, они слабо связаны между собой но сильно - внутри себя

#### Технологии
- Бэк - Golang, gRPC для общения между микросервисами, nginx как балансировщик
- БД - PostgreSQL и Redis
- Для хранения медиафайлов - AmazonS3 либо, в принципе, любое S3-хранилище, можно и self-hosted даже
- Фронтенд - JS Native, React
- Мобильные приложения - Swift/Kotlin

#### Схема проекта
![relations-Схема проекта drawio](https://user-images.githubusercontent.com/27278247/147135119-f17455cc-4443-4e62-9cd8-de5cd41f7f6b.png)

#### Список серверов
- Nginx - основной балансировщик, если предполагать отсутствие CDN (CDN не особо оправдана в случае ориентированности на СНГ), то он должен выдерживать около +- 40000 rps (с учётом запросов, не несущих непосредственной бизнес-логики, с двойным запасом на случай пиковой нагрузки). Судя по [тестам производительности Nginx при работе с HTTPS](https://www.nginx.com/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers/) нам понадобятся, по меньшей мере, 16 ядер процессора.
В тесте использовали 16 ГБ оперативной памяти, с учётом ожидаемого сетевого трафика (в основном - загрузки изображений) в 1 ГБ/сек, её должно хватить.
SSD не играет особой роли для балансировщика, стандартных 128 ГБ под логи будет достаточно, их можно регулярно выгружать.
- Frontend-сервер - можно реализовать тем же Nginx-ом, так как со стороны Nginx весь фронтенд - это несколько файлов статики, которые он просто передаёт по запросу от клиента. Большая их часть не требует загрузки заново в течение длительного времени и не оказывает особого влияния на необходимые мощности оборудования.
- Сервер аутентификации - довольно сильно нагружен множеством небольших запросов на проверку авторизации от других сервисов, нужно достаточно много оперативной памяти
- Сервер чатов - не испытывает сильной нагрузки, достаточно сравнительно небольшого количества ядер CPU и оперативной памяти
- Сервер пользователского контента - высоконагружен, нужно большое количество ядер процессора на обработку изображений (сжатие, например) и большое количество оперативной памяти, чтобы эти изображения хранить, пока они обрабатываются
- S3-хранилище - сильно важен размер, так как статики-медиа в проекте очень много
- Redis - [требует огромного количества оперативной памяти](https://docs.redis.com/latest/rs/administering/designing-production/hardware-requirements/), что неудивительно для in-memory storage
- PostgreSQL - Тоже потребует большого количества оперативной памяти, но из-за того, что в нём будет храниться большАя часть данных

|Сервер|CPU cores|RAM (GB)|SSD(GB)|
| ------------- |--------------- |------------- |---------------|
|Nginx+Frontend|16|16|128|
|Backend-Auth|8|16|128|
|Backend-Chats|8|16|128|
|Backend-Posts|64|64|256|
|Redis|64|150|1500|
|PostgreSQL|64|128|15000|
